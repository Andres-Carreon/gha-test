name: clone repo

on:
  schedule:
    - cron: '0 */1 * * *'
  push:
    branches: ["tm/gha-tuning"]
  workflow_dispatch:
  # Allows you to run this workflow manually from the Actions tab

env:
  owner: "ExodusMovement"
  repository: "exodus-mobile"

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -leo pipefail {0}

    steps:
      - name: Env info check
        run: |
          echo '--- SHELL check ---'
          echo '$SHELL: ' `echo $SHELL`
          echo '$BASH_VERSION ' `echo $BASH_VERSION`
          echo '--- user check ---'
          echo 'whoami:' `whoami`
          echo '$HOME:' $HOME
          echo 'pwd:' `pwd`
          echo '~:' `echo ~`
          echo '--- PATH check ---'
          echo '$PATH:' $PATH
          echo '--- version check ---'
          echo 'watchman version: ' `watchman --version`
          echo 'maestro version: ' `maestro -v`
          echo 'nvm version: ' `nvm -v`
          echo 'node version: ' `node -v`
          echo 'yarn version: ' `yarn -v`
          echo 'playwright version: ' `npx playwright --version`

      - name: install playwright
        run: |
          npx playwright install
          echo 'playwright version: ' `npx playwright --version`

      - name: Checkout app repository
        uses: actions/checkout@v2

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Debug SSH key
        run: |
          ls -la ~/.ssh
          cat ~/.ssh/id_rsa
          ssh -T git@github.com || true

      - name: Clone exodus-browser repository
        run: |
          git clone git@github.com:ExodusMovement/exodus-browser.git
          echo "Cloned repository location:"
          echo "$(pwd)/exodus-browser"

      - name: Navigate to cloned repository
        run: |
          cd exodus-browser
          echo "Current directory: $(pwd)"

      - name: List contents of current directory
        run: |
          ls -la
          cd exodus-browser

      - name: Use Node.js 18.17.1
        run: |
          nvm install 18.17.1
          nvm use 18.17.1
          echo 'node version: ' `node -v`
          echo 'npm version: ' `npm -v`

      - name: Run yarn and yarn dev
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          yarn
          yarn dev
